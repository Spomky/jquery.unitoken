/*! UniToken jQuery Plugin (Minified) v1.2 | (c) 2013 Florent Morselli | www.morselli.fr

This plugin aims to create an interface to get access UniToken keys and retreive files, certificates and methods provided them.
*/
(function(e){var t=1;var n=2;var r=t<<4+n;var i=0;var s=1;var o=2;var u=0;var a=3221225473;var f=3221225474;var l=3221225475;var c=3221225476;var h=3221225478;var p=3221225479;var d=3221225480;var v=3221225481;var m=3221225488;var g=3221225489;var y=3221225490;var b=3221225491;var w=3221225492;var E=3221225493;var S=3221225494;var x=3221225495;var T=3221225496;var N=3221225497;var C=3221225504;var k=3221225505;var L=3221225506;var A=3221225507;var O=3221225508;var M=3472883713;var _=3472883714;var D=3472883715;var P=3472883716;var H=3472883717;var B=3472883718;var j=3472883719;var F=3472883720;var I=3472883722;var q=2684354560;var R=2684354561;var U=2684354562;var z=2684354563;var W=2684354564;var X=2684354565;var V=2684354566;var $=2684354567;var J=2684354568;var K=2684354569;var Q=2684354576;var G={debug:false};var Y={};var Z=function(e){e>>>=0;var t;switch(e){case u:t="No error";break;case a:t="Library not initialized";break;case f:t="Buffer is not big enough";break;case l:t="Invalid parameters";break;case c:t="No permission";break;case h:t="No token available";break;case p:t="Invalid token handle";break;case d:t="Slot is full. No more token can be added";break;case v:t="Invalid slot";break;case m:t="Device error";break;case g:t="The token is already initialized";break;case y:t="Communication error";break;case b:t="PIN error";break;case w:t="User has been locked";break;case E:t="No more users can logon";break;case S:t="No such user available";break;case x:t="Device is not opened yet";break;case T:t="The key already exists";break;case N:t="No key available";break;case C:t="The token is full and can't generate new keys";break;case k:t="Key handle error";break;case L:t="Key generation failed";break;case A:t="Operation not allowed";break;case O:t="Invalid operation";break;case M:t="File initialization failed";break;case _:t="Not enough filesystem space";break;case D:t="Designated file offset is invalid";break;case P:t="Beyond data range";break;case H:t="The file is not opened";break;case B:t="No file";break;case j:t="End of file list";break;case F:t="Filename is too long";break;case I:t="The file already exists";break;case Q:t="Key type not recognized";break;default:t="The result of the method has code: 0x"+e.toString(16)}return t};var et={};et.message=function(e){if(Y.debug)console.log(e)};et.code=function(e){if(Y.debug)et.message(Z(e))};var tt=function(e,t){return{code:e>>>0,message:Z(e),result:t}};var nt=function(e,t,n){var r=this;var i=e;var s=t;var o=n;var a=function(){};r.open=function(){et.message("Opening "+o);var e=i.UT_FS_OpenFile(s,o);et.code(e);return tt(e,undefined)};r.close=function(){et.message("Closing "+o);var e=i.UT_FS_CloseFile(s,o);et.code(e);return tt(e,undefined)};r.remove=function(){et.message("Removing "+o);var e=i.UT_FS_DeleteFile(s,o);et.code(e);return tt(e,undefined)};var f=function(){et.message("Getting size of "+o);var e=i.UT_FS_GetFileSize(s,o);et.code(e);if(e==u){var t=i.FileSize;return tt(e,t)}return undefined};var l=function(){et.message("Getting permission of "+o);var e=i.UT_FS_GetFilePermission(s,o);et.code(e);if(e==u){var t=i.FilePermission;return tt(e,t)}return undefined};r.details=function(){return{filename:o,size:f(),permission:l()}};r.read=function(e,t){et.message("Trying to read "+o+" from offset "+e+" with length "+t);var n=i.UT_FS_ReadFile(s,o,e,t);et.code(n);if(n==u){var r=i.OutBuf;return tt(n,r)}return tt(n,undefined)};r.write=function(e,t,n){et.message("Trying to write "+o+" from offset "+e+" with data length "+t);var r=i.UT_FS_WriteFile(s,o,e,t,n);et.code(r);return tt(r,undefined)};a()};var rt=function(e,t){var n=this;var r=e;var i=t;var o=undefined;var a=function(){et.message("New token interface initialized on slot "+i)};var f=function(){et.message("Trying to open token on slot "+i);var e=r.UT_OpenDevice(i);et.code(e);if(e==u){o=r.Handle;et.message("Handle is 0x"+o.toString(16))}return tt(e,undefined)};var l=function(){et.message("Trying to close token on slot "+i);var e=r.UT_CloseDevice(o);et.code(e);return tt(e,undefined)};var c=function(){return i};var h=function(){et.message("Trying to get type of token on slot "+i);var e=r.UT_GetTokenType(o);et.code(e);if(e==u){var t=r.TokenType;et.message("	Type is "+t);return t}return undefined};var p=function(){et.message("Trying to get firmware version of token on slot "+i);var e=r.UT_GetFirmwareVersion(o);et.code(e);if(e==u){var t=r.FirmwareVersion;et.message("	Firmware version is 0x"+t.toString(16));return t}return undefined};n.logon=function(e,t){et.message("Trying to logon token on slot "+i);var n=r.UT_Logon(o,e,t);et.code(n);return tt(n,undefined)};n.logoff=function(){et.message("Trying to logoff token on slot "+i);var e=r.UT_Logoff(o);et.code(e);return tt(e,undefined)};var d=function(){et.message("Trying to get current user level of token on slot "+i);var e=r.UT_GetCurrentUserLevel(o);et.code(e);if(e==u){var t=r.Level;et.message("	Current user level is "+(t==0?"guest":t==1?"user":"admin"));return t}return undefined};n.changePin=function(e,t,n){et.message("Trying to change PIN of token on slot "+i);if(!n){et.message("Mode is not set. Using current permission");n=1}var u=d();if(n==2)u=s;et.message("Will change password of "+(u==1?"user":"admin"));var a=r.UT_ChangePin(o,u,n,e,t);et.code(a);return tt(a,undefined)};var v=function(){et.message("Trying to get ID of token on slot "+i);var e=r.UT_GetID(o);et.code(e);if(e==u){var t=r.TokenId;et.message("	The ID is "+t);return t}return undefined};n.setID=function(e){et.message("Trying to set ID of token on slot "+i);var t=r.UT_SetID(o,e);et.code(t);return tt(t,undefined)};var m=function(){et.message("Trying to get HID of token on slot "+i);var e=r.UT_GetHID(o);et.code(e);if(e==u){var t=r.HID;et.message("	The ID is "+t+" (0x"+t.toString(16)+")");return t}return undefined};var g=function(){et.message("Trying to get Soft ID of token on slot "+i);var e=r.UT_GetSoftID(o);et.code(e);if(e==u){var t=r.SoftID;et.message("	The ID is "+t+" (0x"+t.toString(16)+")");return t}return undefined};n.setSoftID=function(e){et.message("Trying to set Soft ID of token on slot "+i);var t=r.UT_SetSoftID(o,e);et.code(t);return tt(t,undefined)};n.setLed=function(e){et.message("Trying to set LED mode of token on slot "+i);var t=r.UT_LED(o,e);et.code(t);return tt(t,undefined)};var y=function(){et.message("Trying to get attempt count of token on slot "+i);var e=r.UT_GetAttemptCount(o);et.code(e);if(e==u){var t=r.UserAttempt;et.message("	Attempt count is at "+t);return t}return undefined};n.setAttemptCount=function(e){et.message("Trying to set attempt count of token on slot "+i);var t=r.UT_SetAttemptCount(o,e);et.code(t);return tt(t,undefined)};n.format=function(){et.message("Trying to format token on slot "+i);var e=r.UT_Format(o);et.code(e);return tt(e,undefined)};n.getDetails=function(){et.message("Trying to get details of token on slot "+i);return{slot:c(),type:h(),firmware_version:p(),id:v(),hid:m(),soft_id:g(),attempt_count:y(),user_level:d(),token:this}};n.getRandomData=function(e){et.message("Trying to get random data from token on slot "+i);var t=r.UT_Rand(o,e);et.code(t);if(t==u){var n=r.OutBuf;et.message("	Data: "+n);return tt(t,n)}return tt(t,undefined)};n.generateDESKey=function(){return b(q)};n.generateDES3Key=function(){return b(R)};n.generateAES16Key=function(){return b(U,16)};n.generateAES24Key=function(){return b(U,24)};n.generateRSA128KeyPair=function(){return b(z,128)};n.generateRSA256KeyPair=function(){return b(z,256)};n.generateMD5HMACKey=function(e){return b(V,e)};n.generateSHA1HMACKey=function(e){return b(J,e)};var b=function(e,t){et.message("Trying to get generate a 0x"+e.toString(16)+" key with token on slot "+i);var n=undefined;switch(e){case q:n=r.UT_DESGenerateKey(o);break;case R:n=r.UT_DES3GenerateKey(o);break;case U:n=r.UT_AESGenerateKey(o,t);break;case z:n=r.UT_RSAGenerateKeyPair(o,t,65537);break;case V:n=r.UT_MD5HMACGenerateKey(o,t);break;case J:n=r.UT_SHA1HMACGenerateKey(o,t);break;default:n=Q;break}et.code(n);if(n==u){var s=r.KeyHandle;et.message("	Key handle is 0x"+s.toString(16));return tt(n,s)}return tt(n,undefined)};n.encryptDES=function(e,t,n){return w(q,e,t,n)};n.encryptDES3=function(e,t,n){return w(R,e,t,n)};n.encryptAES=function(e,t,n){return w(U,e,t,n)};n.encryptRSAPublicKey=function(e,t,n){return w(W,e,t,n)};n.encryptRSAPrivateKey=function(e,t,n){return w(X,e,t,n)};n.MD5HMAC=function(e,t,n){return w(V,e,t,n)};n.MD5=function(e,t){return w($,e,t)};n.SHA1HMAC=function(e,t,n){return w(J,e,t,n)};n.SHA1=function(e,t){return w(K,e,t)};var w=function(e,t,n,s){et.message("Trying to encrypt data with key 0x"+t.toString(16)+" of token on slot "+i);var a=undefined;switch(e){case q:a=r.UT_DESEncrypt(o,t,n,s);break;case R:a=r.UT_DES3Encrypt(o,t,n,s);break;case U:a=r.UT_AESEncrypt(o,t,n,s);break;case W:a=r.UT_RSAPubKeyEncrypt(o,t,n,s);break;case X:a=r.UT_RSAPriKeyEncrypt(o,t,n,s);break;case V:a=r.UT_MD5HMAC(o,t,n,s);break;case $:a=r.UT_MD5(o,n,s);break;case J:a=r.UT_SHA1HMAC(o,t,n,s);break;case K:a=r.UT_SHA1(o,n,s);break;default:a=Q;break}et.code(a);if(a==u){if(e==V||e==$||e==J||e==K)return{data:r.Degist,length:r.Degist.length};return{data:r.Encrypt,length:r.EncryptLength}}return tt(a,undefined)};n.decryptDES=function(e,t,n){return E(q,e,t,n)};n.decryptDES3=function(e,t,n){return E(R,e,t,n)};n.decryptAES=function(e,t,n){return E(U,e,t,n)};n.decryptRSAPublicKey=function(e,t,n){return E(W,e,t,n)};n.decryptRSArivateKey=function(e,t,n){return E(X,e,t,n)};var E=function(e,t,n,s){et.message("Trying to decrypt data with key 0x"+t.toString(16)+" of token on slot "+i);var a=undefined;switch(e){case q:a=r.UT_DESDecrypt(o,t,n,s);break;case R:a=r.UT_DES3Decrypt(o,t,n,s);break;case U:a=r.UT_AESDecrypt(o,t,n,s);break;case X:a=r.UT_RSAPriKeyDecrypt(o,t,n,s);break;case W:a=r.UT_RSAPubKeyDecrypt(o,t,n,s);break;default:a=Q;break}et.code(a);if(a==u)return{data:r.OutBuf,length:r.OutBufLength};return tt(a,undefined)};n.deleteDESKey=function(e){return S(q,e)};n.deleteDES3Key=function(e){return S(R,e)};n.deleteAESKey=function(e){return S(U,e)};n.deleteRSAKeyPair=function(e,t){return S(U,e,t)};n.deleteMD5HMACKey=function(e){return S(V,e)};n.deleteSHA1HMACKey=function(e){return S(J,e)};var S=function(e,t,n){et.message("Trying to delete key 0x"+t.toString(16)+" of token on slot "+i);var s=undefined;switch(e){case q:s=r.UT_DESDeleteKey(o,t);break;case R:s=r.UT_DES3DeleteKey(o,t);break;case U:s=r.UT_AESDeleteKey(o,t);break;case z:s=r.RSADeleteKeyPair(o,t,n);break;case V:s=r.UT_MD5DeleteKey(o,t);break;case J:s=r.UT_SHA1DeleteKey(o,t);break;default:s=Q;break}et.code(s);return tt(s,undefined)};n.countKeys=function(){return list={DES:countDESKeys(),DES3:countDES3Keys(),AES:countDESKeys(),RSA:countRSAKeys(),MD5HMAC:countMD5HMACKeys(),SHA1HMAC:countSHA1HMACKeys()}};n.countDESKeys=function(){return x(q)};n.countDES3Keys=function(){return x(R)};n.countAESKeys=function(){return x(U)};n.countRSAKeys=function(){return x(z)};n.countMD5HMACKeys=function(){return x(V)};n.countSHA1HMACKeys=function(){return x(J)};var x=function(e){et.message("Trying to count keys 0x"+e.toString(16)+" of token on slot "+i);var t=undefined;switch(e){case q:t=r.UT_DESGetKeyCount(o);break;case R:t=r.UT_DES3GetKeyCount(o);break;case U:t=r.UT_AESGetKeyCount(o);break;case z:t=r.UT_RSAGetKeyPairCount(o);break;case V:t=r.UT_MD5GetKeyCount(o);break;case J:t=r.UT_SHA1GetKeyCount(o);break;default:t=Q;break}et.code(t);if(t==u)return r.KeyCount;if(t==UT_NO_KEY)return 0;return tt(t,undefined)};n.getKeys=function(){return list={DES:getDESKeys(),DES3:getDES3Keys(),AES:countDESKeys(),MD5HMAC:getMD5HMACKeys(),SHA1HMAC:getSHA1HMACKeys()}};n.getDESKeys=function(){return T(q)};n.getDES3Keys=function(){return T(R)};n.getAESKeys=function(){return T(U)};n.getRSAKeys=function(){return T(z)};n.getMD5HMACKeys=function(){return T(V)};n.getSHA1HMACKeys=function(){return T(J)};var T=function(e){et.message("Trying to get first key 0x"+e.toString(16)+" of token on slot "+i);var t=[];var n=C(e,true);et.code(n);if(n==u){et.message("Key found! We add it in the list");t=N(e,t)}else{return t}et.message("Trying to get next keys 0x"+e.toString(16)+" of token on slot "+i);n=C(e,false);et.code(n);while(n==u){et.message("Key found! We add it in the list");t=N(e,t);n=C(e,false)}return t};var N=function(e,t){var n=r.KeyHandle;var i=undefined;switch(e){case z:var s=r.PubKeyHandle;var a=r.PriKeyHandle;var f=undefined;var l=UT_RSAGetKeyPairModulus(o,n);if(l==u)f=r.ModulusBits;t.push({pub_key:s,priv_key:a,modulus:f});break;case U:var l=r.UT_AESGetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;case V:var l=r.UT_MD5GetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;case J:var l=r.UT_SHA1GetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;default:t.push(n);break}return t};var C=function(e,t){var n=undefined;if(t){switch(e){case q:n=r.UT_DESGetFirstKeyHandle(o);break;case R:n=r.UT_DES3GetFirstKeyHandle(o);break;case U:n=r.UT_AESGetFirstKeyHandle(o);break;case z:n=r.UT_RSAGetFirstKeyPairHandle(o);break;case V:n=r.UT_MD5GetFirstKeyHandle(o);break;case J:n=r.UT_SHA1GetFirstKeyHandle(o);break;default:n=Q;break}}else{switch(e){case q:n=r.UT_DESGetNextKeyHandle(o);break;case R:n=r.UT_DES3GetNextKeyHandle(o);break;case U:n=r.UT_AESGetNextKeyHandle(o);break;case z:n=r.UT_RSAGetNextKeyPairHandle(o);break;case V:n=r.UT_MD5GetNextKeyHandle(o);break;case J:n=r.UT_SHA1GetNextKeyHandle(o);break;default:n=Q;break}}return tt(n,undefined)};n.getRSAPublicKeyHandle=function(e){return k(X,e)};n.getRSAPrivateKeyHandle=function(e){return k(W,e)};var k=function(e,t){et.message("Trying to get handle of RSA key from token on slot "+i);var n=undefined;var s=undefined;switch(e){case W:n=r.embed1.UT_RSAGetPubKeyHandle(o,t);if(n==u){s=r.PubKeyHandle}break;case X:n=r.embed1.UT_RSAGetPriKeyHandle(o,t);if(n==u){s=r.PriKeyHandle}break;default:n=Q;break}et.code(n);if(n==u){et.message("	RSA key handle is: "+s);return tt(n,s)}return n};n.exportRSAPublicKey=function(e){return L(W,e)};var L=function(e,t){et.message("Trying to export key from token on slot "+i);var n=undefined;switch(e){case W:n=r.embed1.UT_RSAPubKeyExport(o,t);break;default:n=Q;break}et.code(n);if(n==u){var s=r.base64pubkey;et.message("	RSA public key is: "+s);return tt(n,s)}return n};n.getSpace=function(){var e=r.UT_FS_GetSpace(o);et.code(e);if(e==u){var t={used:r.UsedSpace,free:r.FreeSpace,total:r.UsedSpace+r.FreeSpace};return tt(e,t)}return tt(e,undefined)};n.countFiles=function(){var e=r.UT_FS_GetFileCount(o);et.code(e);if(e==u){var t=r.FileCount;return tt(e,t)}return tt(e,undefined)};n.getFiles=function(){var e=[];var t=r.UT_FS_GetFirstFileName(o);if(t==u){var i=n.getFile(r.FileName);e.push({details:i.details(),file:i})}else{return e}t=r.UT_FS_GetNextFileName(o);while(t==u){var i=n.getFile(r.FileName);e.push({details:i.details(),file:i});t=r.UT_FS_GetNextFileName(o)}return e};n.getFile=function(e){return new nt(r,o,e)};a();f()};e.Interface=function(t){var n={};var r=e(t)[0];var i=this;var s=function(){et.message("New interface created");et.message("Trying to initialize it");var e=r.UT_Initialize();et.code(e)};var o=function(){r.UT_Finalize();et.message("Interface is finalized.")};i.getTokens=function(){et.message("Trying to get first token");var e=[];var t=r.UT_GetFirstToken();et.code(t);if(t==u){e=a(e)}else{return e}et.message("Trying to get next token");t=r.UT_GetNextToken();et.code(t);while(t==u){e=a(e);t=r.UT_GetNextToken()}return e};var a=function(e){et.message("Will add the token to the list");var t=f(r.SlotID);if(t!=undefined)e.push(t);return e};i.getToken=function(e){return new rt(r,e)};var f=function(e){var t=i.getToken(e);var n=t.getDetails();return n};i.getLibraryVersion=function(){var e=r.UT_GetLibraryVersion();if(e==u)return r.Version;return undefined};s()};var it=undefined;e.fn.unitoken=function(t){Y=e.extend({},G,t);return this.each(function(){if(undefined==e(this).data("unitoken")){if(e(this).attr("type")!=="application/mozilla-npsecuunitoken-scriptable-plugin"){console.log("Selected element is not an embed UniToken scriptable plugin.");return}var t=new e.Interface(this);e(this).data("unitoken",t)}return e(this)})};e.fn.getTokens=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}if(it==undefined)it=e(this).data("unitoken").getTokens();return it};e.fn.refreshTokens=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}it=e(this).data("unitoken").getTokens();return e(this)};e.fn.getToken=function(t){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}if(it==undefined)it=e(this).data("unitoken").getTokens();if(it.length==0)return undefined;for(var n=0;n<it.length;n++)if(it[n].slot==t)return it[n].token;return undefined};e.fn.getLibraryVersion=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}return e(this).data("unitoken").getLibraryVersion()};e.fn.getPluginVersion=function(){return r}})(jQuery)