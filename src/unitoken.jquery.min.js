/*! UniToken jQuery Plugin (Minified) v1.3 | (c) 2013 Florent Morselli | www.morselli.fr

This plugin aims to create an interface to get access UniToken keys and retreive files, certificates and methods provided them.
*/
(function(e){var t=1;var n=3;var r=t<<4+n;var i=0;var s=1;var o=2;var u=0;var a=3221225473;var f=3221225474;var l=3221225475;var c=3221225476;var h=3221225478;var p=3221225479;var d=3221225480;var v=3221225481;var m=3221225488;var g=3221225489;var y=3221225490;var b=3221225491;var w=3221225492;var E=3221225493;var S=3221225494;var x=3221225495;var T=3221225496;var N=3221225497;var C=3221225504;var k=3221225505;var L=3221225506;var A=3221225507;var O=3221225508;var M=3472883713;var _=3472883714;var D=3472883715;var P=3472883716;var H=3472883717;var B=3472883718;var j=3472883719;var F=3472883720;var I=3472883722;var q=2684354560;var R=2684354561;var U=2684354562;var z=2684354563;var W=2684354564;var X=2684354565;var V=2684354566;var $=2684354567;var J=2684354568;var K=2684354569;var Q=2684354576;var G={debug:false,events:{token_inserted:undefined,token_removed:undefined,token_detection_interval:5e3,token_udpated:undefined,key_created:undefined,key_deleted:undefined,random_data:undefined,logon_success:undefined,logon_error:undefined,logoff:undefined}};var Y={};var Z=function(e,t){var n=t.length;for(var r=0;r<n;r++){if(t[r].hid==e.hid)return r}return-1};var et=function(e){e>>>=0;var t;switch(e){case u:t="No error";break;case a:t="Library not initialized";break;case f:t="Buffer is not big enough";break;case l:t="Invalid parameters";break;case c:t="No permission";break;case h:t="No token available";break;case p:t="Invalid token handle";break;case d:t="Slot is full. No more token can be added";break;case v:t="Invalid slot";break;case m:t="Device error";break;case g:t="The token is already initialized";break;case y:t="Communication error";break;case b:t="PIN error";break;case w:t="User has been locked";break;case E:t="No more users can logon";break;case S:t="No such user available";break;case x:t="Device is not opened yet";break;case T:t="The key already exists";break;case N:t="No key available";break;case C:t="The token is full and can't generate new keys";break;case k:t="Key handle error";break;case L:t="Key generation failed";break;case A:t="Operation not allowed";break;case O:t="Invalid operation";break;case M:t="File initialization failed";break;case _:t="Not enough filesystem space";break;case D:t="Designated file offset is invalid";break;case P:t="Beyond data range";break;case H:t="The file is not opened";break;case B:t="No file";break;case j:t="End of file list";break;case F:t="Filename is too long";break;case I:t="The file already exists";break;case Q:t="Key type not recognized";break;default:t="The result of the method has code: 0x"+e.toString(16)}return t};var tt={};tt.message=function(e){if(Y.debug)console.log(e)};tt.code=function(e){if(Y.debug)tt.message(et(e))};var nt=function(e,t){return{code:e>>>0,message:et(e),result:t}};var rt=function(e,t,n){var r=this;var i=e;var s=t;var o=n;var a=function(){};r.open=function(){tt.message("Opening "+o);var e=i.UT_FS_OpenFile(s,o);tt.code(e);return nt(e,undefined)};r.close=function(){tt.message("Closing "+o);var e=i.UT_FS_CloseFile(s,o);tt.code(e);return nt(e,undefined)};r.remove=function(){tt.message("Removing "+o);var e=i.UT_FS_DeleteFile(s,o);tt.code(e);return nt(e,undefined)};var f=function(){tt.message("Getting size of "+o);var e=i.UT_FS_GetFileSize(s,o);tt.code(e);if(e==u){var t=i.FileSize;return nt(e,t)}return undefined};var l=function(){tt.message("Getting permission of "+o);var e=i.UT_FS_GetFilePermission(s,o);tt.code(e);if(e==u){var t=i.FilePermission;return nt(e,t)}return undefined};r.details=function(){return{filename:o,size:f(),permission:l()}};r.read=function(e,t){tt.message("Trying to read "+o+" from offset "+e+" with length "+t);var n=i.UT_FS_ReadFile(s,o,e,t);tt.code(n);if(n==u){var r=i.OutBuf;return nt(n,r)}return nt(n,undefined)};r.write=function(e,t,n){tt.message("Trying to write "+o+" from offset "+e+" with data length "+t);var r=i.UT_FS_WriteFile(s,o,e,t,n);tt.code(r);return nt(r,undefined)};a()};var it=function(e,t){var n=this;var r=e;var i=t;var o=undefined;var a=undefined;var f=function(){if(Y.auto_logoff==true&&Y.auto_logoff_interval>0)a=setTimeout(function(){tt.message("Auto logoff after inactivity");n.logoff()},Y.auto_logoff_interval)};var l=function(){tt.message("New token interface initialized on slot "+i);f()};var c=function(){tt.message("Trying to open token on slot "+i);var e=r.UT_OpenDevice(i);tt.code(e);if(e==u){o=r.Handle;tt.message("Handle is 0x"+o.toString(16))}return nt(e,undefined)};var h=function(){tt.message("Trying to close token on slot "+i);var e=r.UT_CloseDevice(o);tt.code(e);return nt(e,undefined)};var p=function(){return i};var d=function(){tt.message("Trying to get type of token on slot "+i);var e=r.UT_GetTokenType(o);tt.code(e);if(e==u){var t=r.TokenType;tt.message("Type is "+t);return t}return undefined};var v=function(){tt.message("Trying to get firmware version of token on slot "+i);var e=r.UT_GetFirmwareVersion(o);tt.code(e);if(e==u){var t=r.FirmwareVersion;tt.message("Firmware version is 0x"+t.toString(16));return t}return undefined};n.logon=function(e,t){tt.message("Trying to logon token on slot "+i);var n=r.UT_Logon(o,e,t);tt.code(n);if(n==u&&Y.events.logon_success!=undefined)Y.events.logon_success(e);if(n!=u&&Y.events.logon_error!=undefined)Y.events.logon_error(e);return nt(n,undefined)};n.logoff=function(){tt.message("Trying to logoff token on slot "+i);var e=r.UT_Logoff(o);tt.code(e);if(e==u&&Y.events.logoff!=undefined)Y.events.logoff();return nt(e,undefined)};var m=function(){tt.message("Trying to get current user level of token on slot "+i);var e=r.UT_GetCurrentUserLevel(o);tt.code(e);if(e==u){var t=r.Level;tt.message("Current user level is "+(t==0?"guest":t==1?"user":"admin"));return t}return undefined};n.changePin=function(e,t,a){tt.message("Trying to change PIN of token on slot "+i);if(!a){tt.message("Mode is not set. Using current permission");a=1}var f=m();if(a==2)f=s;tt.message("Will change password of "+(f==1?"user":"admin"));var l=r.UT_ChangePin(o,f,a,e,t);tt.code(l);if(l==u&&Y.events.token_udpated!=undefined)Y.events.token_udpated(n.getDetails());return nt(l,undefined)};var g=function(){tt.message("Trying to get ID of token on slot "+i);var e=r.UT_GetID(o);tt.code(e);if(e==u){var t=r.TokenId;tt.message("The ID is "+t);return t}return undefined};n.setID=function(e){tt.message("Trying to set ID of token on slot "+i);var t=r.UT_SetID(o,e);tt.code(t);if(t==u&&Y.events.token_udpated!=undefined)Y.events.token_udpated(n.getDetails());return nt(t,undefined)};var y=function(){tt.message("Trying to get HID of token on slot "+i);var e=r.UT_GetHID(o);tt.code(e);if(e==u){var t=r.HID;tt.message("The ID is "+t+" (0x"+t.toString(16)+")");return t}return undefined};var b=function(){tt.message("Trying to get Soft ID of token on slot "+i);var e=r.UT_GetSoftID(o);tt.code(e);if(e==u){var t=r.SoftID;tt.message("The ID is "+t+" (0x"+t.toString(16)+")");return t}return undefined};n.setSoftID=function(e){tt.message("Trying to set Soft ID of token on slot "+i);var t=r.UT_SetSoftID(o,e);tt.code(t);if(t==u&&Y.events.token_udpated!=undefined)Y.events.token_udpated(n.getDetails());return nt(t,undefined)};n.setLed=function(e){tt.message("Trying to set LED mode of token on slot "+i);var t=r.UT_LED(o,e);tt.code(t);if(t==u&&Y.events.token_udpated!=undefined)Y.events.token_udpated(n.getDetails());return nt(t,undefined)};var w=function(){tt.message("Trying to get attempt count of token on slot "+i);var e=r.UT_GetAttemptCount(o);tt.code(e);if(e==u){var t=r.UserAttempt;tt.message("Attempt count is at "+t);return t}return undefined};n.setAttemptCount=function(e){tt.message("Trying to set attempt count of token on slot "+i);var t=r.UT_SetAttemptCount(o,e);tt.code(t);if(t==u&&Y.events.token_udpated!=undefined)Y.events.token_udpated(n.getDetails());return nt(t,undefined)};n.format=function(){tt.message("Trying to format token on slot "+i);var e=r.UT_Format(o);tt.code(e);return nt(e,undefined)};n.getDetails=function(){tt.message("Trying to get details of token on slot "+i);return{slot:p(),type:d(),firmware_version:v(),id:g(),hid:y(),soft_id:b(),attempt_count:w(),user_level:m(),token:this}};n.getRandomData=function(e){tt.message("Trying to get random data from token on slot "+i);var t=r.UT_Rand(o,e);tt.code(t);if(t==u){var n=r.OutBuf;tt.message("Data: "+n);if(Y.events.random_data!=undefined)Y.events.random_data(n);return nt(t,n)}return nt(t,undefined)};n.generateDESKey=function(){return E(q)};n.generateDES3Key=function(){return E(R)};n.generateAES16Key=function(){return E(U,16)};n.generateAES24Key=function(){return E(U,24)};n.generateRSA128KeyPair=function(){return E(z,128)};n.generateRSA256KeyPair=function(){return E(z,256)};n.generateMD5HMACKey=function(e){return E(V,e)};n.generateSHA1HMACKey=function(e){return E(J,e)};var E=function(e,t){tt.message("Trying to get generate a 0x"+e.toString(16)+" key with token on slot "+i);var n=undefined;switch(e){case q:n=r.UT_DESGenerateKey(o);break;case R:n=r.UT_DES3GenerateKey(o);break;case U:n=r.UT_AESGenerateKey(o,t);break;case z:n=r.UT_RSAGenerateKeyPair(o,t,65537);break;case V:n=r.UT_MD5HMACGenerateKey(o,t);break;case J:n=r.UT_SHA1HMACGenerateKey(o,t);break;default:n=Q;break}tt.code(n);if(n==u){var s=r.KeyHandle;tt.message("Key handle is 0x"+s.toString(16));if(Y.events.key_created!=undefined)Y.events.key_created(e,s);return nt(n,s)}return nt(n,undefined)};n.encryptDES=function(e,t,n){return S(q,e,t,n)};n.encryptDES3=function(e,t,n){return S(R,e,t,n)};n.encryptAES=function(e,t,n){return S(U,e,t,n)};n.encryptRSAPublicKey=function(e,t,n){return S(W,e,t,n)};n.encryptRSAPrivateKey=function(e,t,n){return S(X,e,t,n)};n.MD5HMAC=function(e,t,n){return S(V,e,t,n)};n.MD5=function(e,t){return S($,e,t)};n.SHA1HMAC=function(e,t,n){return S(J,e,t,n)};n.SHA1=function(e,t){return S(K,e,t)};var S=function(e,t,n,s){tt.message("Trying to encrypt data with key 0x"+t.toString(16)+" of token on slot "+i);var a=undefined;switch(e){case q:a=r.UT_DESEncrypt(o,t,n,s);break;case R:a=r.UT_DES3Encrypt(o,t,n,s);break;case U:a=r.UT_AESEncrypt(o,t,n,s);break;case W:a=r.UT_RSAPubKeyEncrypt(o,t,n,s);break;case X:a=r.UT_RSAPriKeyEncrypt(o,t,n,s);break;case V:a=r.UT_MD5HMAC(o,t,n,s);break;case $:a=r.UT_MD5(o,n,s);break;case J:a=r.UT_SHA1HMAC(o,t,n,s);break;case K:a=r.UT_SHA1(o,n,s);break;default:a=Q;break}tt.code(a);if(a==u){if(e==V||e==$||e==J||e==K)return{data:r.Degist,length:r.Degist.length};return{data:r.Encrypt,length:r.EncryptLength}}return nt(a,undefined)};n.decryptDES=function(e,t,n){return x(q,e,t,n)};n.decryptDES3=function(e,t,n){return x(R,e,t,n)};n.decryptAES=function(e,t,n){return x(U,e,t,n)};n.decryptRSAPublicKey=function(e,t,n){return x(W,e,t,n)};n.decryptRSArivateKey=function(e,t,n){return x(X,e,t,n)};var x=function(e,t,n,s){tt.message("Trying to decrypt data with key 0x"+t.toString(16)+" of token on slot "+i);var a=undefined;switch(e){case q:a=r.UT_DESDecrypt(o,t,n,s);break;case R:a=r.UT_DES3Decrypt(o,t,n,s);break;case U:a=r.UT_AESDecrypt(o,t,n,s);break;case X:a=r.UT_RSAPriKeyDecrypt(o,t,n,s);break;case W:a=r.UT_RSAPubKeyDecrypt(o,t,n,s);break;default:a=Q;break}tt.code(a);if(a==u)return{data:r.OutBuf,length:r.OutBufLength};return nt(a,undefined)};n.deleteDESKeys=function(){return T(q)};n.deleteDES3Keys=function(){return T(R)};n.deleteAESKeys=function(){return T(U)};n.deleteRSAKeyPairs=function(){return T(z)};n.deleteMD5HMACKeys=function(){return T(V)};n.deleteSHA1HMACKeys=function(){return T(J)};var T=function(e){var t=L(e);if(t.code!=u)return;for(var n=0;n<t.result.length;n++){if(e==z)C(e,t.result[n].pub,t.result[n].pub);else C(e,t.result[n].handle)}};n.deleteDESKey=function(e){return C(q,e)};n.deleteDES3Key=function(e){return C(R,e)};n.deleteAESKey=function(e){return C(U,e)};n.deleteRSAKeyPair=function(e,t){return C(z,e,t)};n.deleteMD5HMACKey=function(e){return C(V,e)};n.deleteSHA1HMACKey=function(e){return C(J,e)};var C=function(e,t,n){tt.message("Trying to delete key 0x"+t.toString(16)+" of token on slot "+i);var s=undefined;switch(e){case q:s=r.UT_DESDeleteKey(o,t);break;case R:s=r.UT_DES3DeleteKey(o,t);break;case U:s=r.UT_AESDeleteKey(o,t);break;case z:s=r.RSADeleteKeyPair(o,t,n);break;case V:s=r.UT_MD5DeleteKey(o,t);break;case J:s=r.UT_SHA1DeleteKey(o,t);break;default:s=Q;break}tt.code(s);if(s==u&&Y.events.key_deleted!=undefined)Y.events.key_deleted(e,t,n);return nt(s,undefined)};n.countKeys=function(){var e=n.countDESKeys();var t=n.countDES3Keys();var r=n.countAESKeys();var i=n.countRSAKeys();var s=n.countMD5HMACKeys();var o=n.countSHA1HMACKeys();var a={DES:e,DES3:t,AES:r,RSA:i,MD5HMAC:s,SHA1HMAC:o,total:e+t+r+i+s+o};return nt(u,a)};n.countDESKeys=function(){return k(q)};n.countDES3Keys=function(){return k(R)};n.countAESKeys=function(){return k(U)};n.countRSAKeys=function(){return k(z)};n.countMD5HMACKeys=function(){return k(V)};n.countSHA1HMACKeys=function(){return k(J)};var k=function(e){tt.message("Trying to count keys 0x"+e.toString(16)+" of token on slot "+i);var t=undefined;switch(e){case q:t=r.UT_DESGetKeyCount(o);break;case R:t=r.UT_DES3GetKeyCount(o);break;case U:t=r.UT_AESGetKeyCount(o);break;case z:t=r.UT_RSAGetKeyPairCount(o);break;case V:t=r.UT_MD5GetKeyCount(o);break;case J:t=r.UT_SHA1GetKeyCount(o);break;default:t=Q;break}tt.code(t);if(t==u)return r.KeyCount;if(t>>>0==N)return 0;return nt(t,undefined)};n.getKeys=function(){var e={DES:n.getDESKeys(),DES3:n.getDES3Keys(),AES:n.getAESKeys(),MD5HMAC:n.getMD5HMACKeys(),SHA1HMAC:n.getSHA1HMACKeys()};return nt(u,e)};n.getDESKeys=function(){return L(q)};n.getDES3Keys=function(){return L(R)};n.getAESKeys=function(){return L(U)};n.getRSAKeys=function(){return L(z)};n.getMD5HMACKeys=function(){return L(V)};n.getSHA1HMACKeys=function(){return L(J)};var L=function(e){tt.message("Trying to get first key 0x"+e.toString(16)+" of token on slot "+i);var t=[];var n=O(e,true);tt.code(n);if(n==u){tt.message("Key found! We add it in the list");t=A(e,t)}else{return nt(u,t)}tt.message("Trying to get next keys 0x"+e.toString(16)+" of token on slot "+i);n=O(e,false);tt.code(n);while(n==u){tt.message("Key found! We add it in the list");t=A(e,t);n=O(e,false)}return nt(u,t)};var A=function(e,t){var n=r.KeyHandle;var i=undefined;switch(e){case z:var s=r.PubKeyHandle;var a=r.PriKeyHandle;var f=undefined;var l=UT_RSAGetKeyPairModulus(o,n);if(l==u)f=r.ModulusBits;t.push({pub_key:s,priv_key:a,modulus:f});break;case U:var l=r.UT_AESGetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;case V:var l=r.UT_MD5GetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;case J:var l=r.UT_SHA1GetKeyLen(o,n);if(l==u)len=r.KeyLength;t.push({handle:n,length:len});break;default:t.push({handle:n});break}return t};var O=function(e,t){var n=undefined;if(t){switch(e){case q:n=r.UT_DESGetFirstKeyHandle(o);break;case R:n=r.UT_DES3GetFirstKeyHandle(o);break;case U:n=r.UT_AESGetFirstKeyHandle(o);break;case z:n=r.UT_RSAGetFirstKeyPairHandle(o);break;case V:n=r.UT_MD5GetFirstKeyHandle(o);break;case J:n=r.UT_SHA1GetFirstKeyHandle(o);break;default:n=Q;break}}else{switch(e){case q:n=r.UT_DESGetNextKeyHandle(o);break;case R:n=r.UT_DES3GetNextKeyHandle(o);break;case U:n=r.UT_AESGetNextKeyHandle(o);break;case z:n=r.UT_RSAGetNextKeyPairHandle(o);break;case V:n=r.UT_MD5GetNextKeyHandle(o);break;case J:n=r.UT_SHA1GetNextKeyHandle(o);break;default:n=Q;break}}return n};n.getRSAPublicKeyHandle=function(e){return M(X,e)};n.getRSAPrivateKeyHandle=function(e){return M(W,e)};var M=function(e,t){tt.message("Trying to get handle of RSA key from token on slot "+i);var n=undefined;var s=undefined;switch(e){case W:n=r.embed1.UT_RSAGetPubKeyHandle(o,t);if(n==u){s=r.PubKeyHandle}break;case X:n=r.embed1.UT_RSAGetPriKeyHandle(o,t);if(n==u){s=r.PriKeyHandle}break;default:n=Q;break}tt.code(n);if(n==u){tt.message("RSA key handle is: "+s);return nt(n,s)}return n};n.exportRSAPublicKey=function(e){return _(W,e)};var _=function(e,t){tt.message("Trying to export key from token on slot "+i);var n=undefined;switch(e){case W:n=r.embed1.UT_RSAPubKeyExport(o,t);break;default:n=Q;break}tt.code(n);if(n==u){var s=r.base64pubkey;tt.message("RSA public key is: "+s);return nt(n,s)}return n};n.getSpace=function(){var e=r.UT_FS_GetSpace(o);tt.code(e);if(e==u){var t={used:r.UsedSpace,free:r.FreeSpace,total:r.UsedSpace+r.FreeSpace};return nt(e,t)}return nt(e,undefined)};n.countFiles=function(){var e=r.UT_FS_GetFileCount(o);tt.code(e);if(e==u){var t=r.FileCount;return nt(e,t)}return nt(e,undefined)};n.getFiles=function(){var e=[];var t=r.UT_FS_GetFirstFileName(o);if(t==u){var i=n.getFile(r.FileName);e.push({details:i.details(),file:i})}else{return e}t=r.UT_FS_GetNextFileName(o);while(t==u){var i=n.getFile(r.FileName);e.push({details:i.details(),file:i});t=r.UT_FS_GetNextFileName(o)}return e};n.getFile=function(e){return new rt(r,o,e)};l();c()};e.Interface=function(t){var n=e(t)[0];var r=this;var i=undefined;var s=undefined;var o=function(){var e=i;var t=l();var n=false;if(Y.events.token_inserted!=undefined){for(var s=0;s<t.length;s++){if(Z(t[s],e)==-1){Y.events.token_inserted(t[s]);n=true}}}if(Y.events.token_removed!=undefined){for(var s=0;s<e.length;s++){if(Z(e[s],t)==-1){Y.events.token_removed(e[s]);n=true}}}if(n)r.refreshTokens()};r.startAutodetection=function(){r.stopAutodetection();if(Y.events.token_detection_interval>0&&(Y.events.token_inserted!=undefined||Y.events.stoken_removed!=undefined))s=setInterval(function(){o()},Y.token_detection_interval)};r.stopAutodetection=function(){if(s!=undefined)clearInterval(s)};var a=function(){tt.message("New interface created");tt.message("Trying to initialize it");r.refreshTokens();r.startAutodetection();var e=n.UT_Initialize();tt.code(e)};var f=function(){n.UT_Finalize();tt.message("Interface is finalized.")};var l=function(){tt.message("Trying to get first token");var e=[];var t=n.UT_GetFirstToken();tt.code(t);if(t!=u){return e}e=c(e);tt.message("Trying to get next token");t=n.UT_GetNextToken();tt.code(t);while(t==u){e=c(e);t=n.UT_GetNextToken()}return e};r.refreshTokens=function(){i=l()};r.getTokens=function(){if(i!=undefined)return i;r.refreshTokens();return i};var c=function(e){tt.message("Will add the token to the list");var t=h(n.SlotID);if(t!=undefined)e.push(t);return e};r.getToken=function(e){return new it(n,e)};var h=function(e){var t=r.getToken(e);var n=t.getDetails();return n};r.getLibraryVersion=function(){var e=n.UT_GetLibraryVersion();if(e==u)return n.Version;return undefined};a()};e.fn.unitoken=function(t){Y=e.extend({},G,t);return this.each(function(){if(undefined==e(this).data("unitoken")){if(e(this).attr("type")!=="application/mozilla-npsecuunitoken-scriptable-plugin"){console.log("Selected element is not an embed UniToken scriptable plugin.");return}var t=new e.Interface(this);e(this).data("unitoken",t)}return e(this)})};e.fn.getTokens=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}return e(this).data("unitoken").getTokens()};e.fn.refreshTokens=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}e(this).data("unitoken").refreshTokens();return e(this)};e.fn.getToken=function(t){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}return e(this).data("unitoken").getToken(t)};e.fn.getLibraryVersion=function(){if(undefined==e(this).data("unitoken")){console.log("Selected element is not an UniToken object or must be initialized. Please use 'unitoken' function first.");return}return e(this).data("unitoken").getLibraryVersion()};e.fn.getPluginVersion=function(){return r}})(jQuery)